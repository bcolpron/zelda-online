<!DOCTYPE html>
<html>
<style>
body {
    background-color: black;
    text-align: center;
    margin: 40px;
}
</style>
<body>

<canvas id="myCanvas" width="512" height="352"> </canvas>

<script>
document.addEventListener("DOMContentLoaded", function(event) { 
    main();
});

const SPRITE_SIZE = 16;
const TILE_SIZE = 16;
const AREA_WIDTH_TILES = 16;
const AREA_WIDTH = AREA_WIDTH_TILES * TILE_SIZE;
const AREA_HEIGHT_TILES = 11;
const AREA_HEIGHT = AREA_HEIGHT_TILES * TILE_SIZE;
const AREA_PAN_TIME = 1;
const ZOOM = 2;

const NONE=0, UP=1, DOWN=2, LEFT=3, RIGHT=4;

class Sprite {
    constructor(path) {
        this.sprites = new Image();
        this.sprites.src = location.href + path;
        this.direction = DOWN;
    }

    setDirection(dir) {
        this.direction = dir;
    }

    draw(ctx, x, y) {
        var offset = this.direction == DOWN ? 0 : this.direction == LEFT ? 1 : this.direction == UP  ? 2 : 3;
        ctx.drawImage(this.sprites, (14+16)*offset, 14+16, SPRITE_SIZE, SPRITE_SIZE, ZOOM*x, ZOOM*y, ZOOM*SPRITE_SIZE, ZOOM*SPRITE_SIZE);
    }
};

function main() {
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    var map = new Image();
    map.onload = ()=> {
        requestAnimationFrame(draw);
    }
    map.src = location.href + "images/map.png";
    var link = new Sprite("images/sprites.png")

    var x = 7*AREA_WIDTH + 5*TILE_SIZE;
    var y = 7*AREA_HEIGHT + 5*TILE_SIZE;

    function draw() {
        var mapOffsetX = Math.floor(x/AREA_WIDTH);
        var relativeX = x % AREA_WIDTH;
        var mapOffsetY = Math.floor(y/AREA_HEIGHT);
        var relativeY = y % AREA_HEIGHT;

        if (anim) {
            var slice = performance.now() - anim.start;
            //offsetX += Math.floor(AREA_WIDTH*(anim.destX - anim.origX)*slice/AREA_PAN_TIME);
            //offsetY += Math.floor(AREA_HEIGHT*(anim.destY - anim.origY)*slice/AREA_PAN_TIME);
        }
        ctx.drawImage(map, mapOffsetX*AREA_WIDTH, mapOffsetY*AREA_HEIGHT, AREA_WIDTH, AREA_HEIGHT, 0, 0, ZOOM*AREA_WIDTH, ZOOM*AREA_HEIGHT);
        link.draw(ctx, relativeX, relativeY);
        requestAnimationFrame(draw);
    }

    var anim = null;
    function moveTo(dX, dY) {
        var nX = x + dX;
        var nY = y + dY;
        if (nX < 0 || nX >= 16*AREA_WIDTH-TILE_SIZE || nY < 0 || nY >= 8*AREA_HEIGHT-TILE_SIZE) return;

        if (dX) {
            var mod = nY%8;
            if (mod > 4) {
                nY += 1;
            } else if (mod) {
                nY -= 1;
            }
        }
        if (dY) {
            var mod = nX%8;
            if (mod > 4) {
                nX += 1;
            } else if (mod) {
                nX -= 1;
            }
        }

        anim = {
            "origX": x,
            "origY": y,
            "destX": nX,
            "destY": nY,
            "start": performance.now()
        };
        //setTimeout(()=>{
            x = anim.destX;
            y = anim.destY;
        //    anim = null;
        //    }, AREA_PAN_TIME);
    }

    class UserControl {
        constructor() {
            this.up = this.down = this.left = this.right = false;
            this.direction = NONE;
        }
    };
    var control = new UserControl();

    document.onkeydown = (e) => {
        switch(e.keyCode) {
            case 37:
                control.left = true;
                control.direction = LEFT;
                break;
            case 38:
                control.up = true;
                control.direction = UP;
                break;
            case 39:
                control.right = true;
                control.direction = RIGHT;
                break;
            case 40:
                control.down = true;
                control.direction = DOWN;
                break;
        }
        link.setDirection(control.direction);
    }
    document.onkeyup = (e) => {
        switch(e.keyCode) {
            case 37:
                control.left = false;
                if (control.direction == LEFT) control.direction = NONE;
                break;
            case 38:
                control.up = false;
                if (control.direction == UP) control.direction = NONE;
                break;
            case 39:
                control.right = false;
                if (control.direction == RIGHT) control.direction = NONE;
                break;
            case 40:
                control.down = false;
                if (control.direction == DOWN) control.direction = NONE;
                break;
        }
        if (control.left) control.direction = LEFT;
        else if (control.up) control.direction = UP;
        else if (control.right) control.direction = RIGHT;
        else if (control.DOWN) control.direction = DOWN;

        if (control.direction != NONE) {
            link.setDirection(control.direction);
        }
    }

    setInterval(() => {
        if (control.direction == UP) {moveTo(0, -1);}
        if (control.direction == DOWN) {moveTo(0, 1);}
        if (control.direction == LEFT) {moveTo(-1, 0);}
        if (control.direction == RIGHT) {moveTo(1, 0);}
    }, 12);
}

</script>
</body>
</html>
